name: Deploy Pharmaceutical Barcode Scanner

on:
  push:
    branches: [ main, develop ]
    paths: [ 'farmacia_interface/**' ]
  pull_request:
    branches: [ main ]

jobs:
  test-interface:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # CAMBIAR DE 3.9 A 3.10
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libzbar0 libzbar-dev
    
    - name: Install Python dependencies
      run: |
        cd farmacia_interface
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create minimal test secrets
      run: |
        cd farmacia_interface
        mkdir -p .streamlit
        echo '# Test secrets for CI' > .streamlit/secrets.toml
    
    - name: Test basic imports
      run: |
        cd farmacia_interface
        python -c "
        import sys
        print('ğŸ” Testing basic imports...')
        
        try:
            import streamlit as st
            print('âœ… Streamlit import OK')
        except Exception as e:
            print(f'âŒ Streamlit error: {e}')
            sys.exit(1)
        
        try:
            import cv2
            print('âœ… OpenCV import OK')
        except Exception as e:
            print(f'âŒ OpenCV error: {e}')
            sys.exit(1)
        
        try:
            import pandas as pd
            print('âœ… Pandas import OK')
        except Exception as e:
            print(f'âŒ Pandas error: {e}')
            sys.exit(1)
        
        try:
            from pyzbar import pyzbar
            print('âœ… pyzbar import OK')
        except Exception as e:
            print(f'âŒ pyzbar error: {e}')
            sys.exit(1)
        
        try:
            import zxingcpp
            print('âœ… zxing-cpp import OK')
        except Exception as e:
            print(f'âŒ zxing-cpp error: {e}')
            # No fallar por zxing-cpp ya que pyzbar es suficiente
        
        print('ğŸ‰ Basic imports successful!')
        "
    
    - name: Test app syntax
      run: |
        cd farmacia_interface
        python -m py_compile streamlit_app.py
        echo "âœ… Streamlit app syntax is valid"

  deploy-info:
    needs: test-interface
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Interface ready notification
      run: |
        echo "ğŸ‰ Interface tests passed!"
        echo ""
        echo "ğŸ“± Your Streamlit interface is ready for deployment:"
        echo "1. Go to https://share.streamlit.io/"
        echo "2. Connect repository: ${{ github.repository }}"
        echo "3. Main file: farmacia_interface/streamlit_app.py"
        echo "4. Deploy!"
        echo ""
        echo "ğŸ”— Repository: https://github.com/${{ github.repository }}"
        echo "ğŸ“ Interface file: farmacia_interface/streamlit_app.py"

